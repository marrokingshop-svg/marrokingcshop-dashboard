<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marroking Shop - Sistema Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f4f6f9; }
        .login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffffff; }
        .login-box { padding: 60px; border-radius: 18px; border: 1px solid rgba(212,175,55,0.25); box-shadow: 0 30px 60px rgba(0,0,0,0.06); width: 400px; text-align: center; }
        .login-box input { width: 100%; padding: 16px; margin-bottom: 22px; border: 1px solid #e5e7eb; border-radius: 12px; }
        .login-box button { width: 100%; padding: 16px; border: none; background: linear-gradient(90deg, #d4af37, #b8860b); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; }

        .layout { display: none; min-height: 100vh; }
        .sidebar { width: 250px; background: #ffffff; border-right: 1px solid rgba(212,175,55,0.25); padding: 40px 25px; position: fixed; height: 100vh; }
        .sidebar a { display: block; padding: 12px 0; cursor: pointer; }
        .main { margin-left: 300px; padding: 50px; }

        table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #d4af37; }

        .search-input { width: 100%; padding: 10px; margin-top: 10px; }
        .btn { padding: 8px 14px; margin: 5px; cursor: pointer; border: none; border-radius: 6px; }
        .btn-sync { background: #3483fa; color: white; }
    </style>
</head>

<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>MARROKING SHOP</h2>
        <input id="username" placeholder="Usuario">
        <input id="password" type="password" placeholder="ContraseÃ±a">
        <button onclick="login()">ACCEDER</button>
    </div>
</div>

<!-- DASHBOARD -->
<div class="layout" id="dashboardLayout">
    <div class="sidebar">
        <h3 style="color:#d4af37;">MENÃš</h3>
        <a onclick="loadProducts()">Inventario ML</a>
        <a onclick="logout()">Cerrar sesiÃ³n</a>
    </div>

    <div class="main">
        <div id="inventario">
            <h2>Inventario Mercado Libre</h2>

            <button class="btn btn-sync" onclick="syncML()">ðŸ”„ Sincronizar</button>

            <input id="searchInput" class="search-input" placeholder="Buscar producto..." onkeyup="applyFilters()">

            <div>
                <button class="btn" onclick="setStatusFilter('all')">Todas</button>
                <button class="btn" onclick="setStatusFilter('active')">Activas</button>
                <button class="btn" onclick="setStatusFilter('paused')">Pausadas/Cerradas</button>
                <button class="btn" onclick="setStatusFilter('nostock')">Sin stock</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>ML ID</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const API = "https://marrokingcshop-api.onrender.com";

let allProducts = [];
let currentStatusFilter = "all";

// ===== AUTO LOGIN =====
window.onload = function(){
    const token = localStorage.getItem("token");
    if(token){
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardLayout").style.display = "flex";
        loadProducts();
    }
};

// ===== LOGIN =====
window.login = async function () {
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const resp = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
        })
    });

    const data = await resp.json();
    if (data.access_token) {
        localStorage.setItem("token", data.access_token);
        location.reload();
    } else {
        alert("Credenciales invÃ¡lidas");
    }
};

// ===== CARGAR PRODUCTOS =====
async function loadProducts(){
    // Limpiamos la tabla antes de cargar para evitar ver datos viejos
    document.getElementById("productTable").innerHTML = "<tr><td colspan='4'>Cargando datos frescos...</td></tr>";
    
    try {
        const resp = await fetch(API + "/products-grouped", {
            headers:{
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        });

        const data = await resp.json();
        console.log("DATOS RECIBIDOS:", data);
        allProducts = data.products || [];
        applyFilters();
    } catch (error) {
        console.error("Error al cargar:", error);
        alert("Error al conectar con el servidor");
    }
}

// ===== FILTROS (EL CORAZÃ“N DEL CAMBIO) =====
function setStatusFilter(status){
    currentStatusFilter = status;
    applyFilters();
}

function applyFilters(){
    const searchInput = document.getElementById("searchInput");
    const text = (searchInput.value || "").toLowerCase().trim();

    let filtered = [...allProducts];

    // FILTRO DE ESTADO ESTRICTO
    if(currentStatusFilter === "active"){
        // SOLO lo que MELI diga que es active
        filtered = filtered.filter(p => p.status === "active");
    } 
    else if(currentStatusFilter === "paused"){
        // Todo lo que NO sea active se va a esta pestaÃ±a
        filtered = filtered.filter(p => p.status !== "active");
    } 
    else if(currentStatusFilter === "nostock"){
        filtered = filtered.filter(p => {
            let total = 0;
            (p.variations || []).forEach(v => total += v.stock);
            return total === 0;
        });
    }

    // FILTRO DE BÃšSQUEDA
    if(text){
        filtered = filtered.filter(p =>
            (p.title || "").toLowerCase().includes(text) ||
            (p.variations || []).some(v => (v.name || "").toLowerCase().includes(text))
        );
    }

    renderTable(filtered);
}

// ===== RENDERIZAR TABLA =====
function renderTable(productsList){
    const table = document.getElementById("productTable");
    table.innerHTML = ""; // Limpieza total de la tabla

    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>No se encontraron productos en esta categorÃ­a</td></tr>";
        return;
    }

    // Ordenar alfabÃ©ticamente
    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    productsList.forEach(item => {
        let totalStock = 0;
        (item.variations || []).forEach(v => totalStock += v.stock);

        const status = (item.status || "").toLowerCase();
        let rowStyle = "";
        let stockStyle = "color:green;font-weight:bold;";
        let statusLabel = "";

        // Si el producto no es activo, le ponemos un estilo visual distinto
        if(status !== "active"){
            rowStyle = "background:#f9f9f9; color:#666;";
            statusLabel = `<span style="color:#d9534f; font-size:10px; margin-left:10px; border:1px solid; padding:2px 4px; border-radius:4px;">${status.toUpperCase()}</span>`;
        }

        if(totalStock === 0) stockStyle = "color:red;font-weight:bold;";

        // Fila Principal
        table.innerHTML += `
            <tr style="${rowStyle}">
                <td><div style="display:flex; align-items:center;"><strong>${item.title}</strong> ${statusLabel}</div></td>
                <td>$${item.variations?.[0]?.price || 0}</td>
                <td style="${stockStyle}">${totalStock}</td>
                <td style="font-family:monospace; font-size:12px;">${item.meli_item_id || ""}</td>
            </tr>
        `;

        // Filas de Variaciones
        (item.variations || []).forEach(v => {
            table.innerHTML += `
                <tr style="${rowStyle} border-bottom: 1px dashed #eee;">
                    <td style="padding-left:30px; font-size:13px; color:#555;">â”” ${v.name}</td>
                    <td></td>
                    <td style="font-size:13px;">${v.stock}</td>
                    <td style="font-size:11px; color:#999; font-family:monospace;">${v.meli_id}</td>
                </tr>
            `;
        });
    });
}

// ===== SINCRONIZAR =====
async function syncML(){
    const btn = document.querySelector(".btn-sync");
    const originalText = btn.innerHTML;
    btn.innerHTML = "âŒ› Sincronizando...";
    btn.disabled = true;

    try {
        const resp = await fetch(API + "/meli/sync", {
            method:"POST",
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        if(resp.ok){
            alert("Â¡SincronizaciÃ³n Profunda Exitosa! Los datos se han actualizado.");
            await loadProducts();
        } else {
            alert("Error en el servidor al sincronizar");
        }
    } catch (e) {
        alert("Error de conexiÃ³n");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// ===== LOGOUT =====
function logout(){
    localStorage.clear();
    location.reload();
}
</script>

</body>
</html> 