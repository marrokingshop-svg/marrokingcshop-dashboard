<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marroking Shop - Sistema Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f4f6f9; }
        .login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffffff; }
        .login-box { padding: 60px; border-radius: 18px; border: 1px solid rgba(212,175,55,0.25); box-shadow: 0 30px 60px rgba(0,0,0,0.06); width: 400px; text-align: center; }
        .login-box input { width: 100%; padding: 16px; margin-bottom: 22px; border: 1px solid #e5e7eb; border-radius: 12px; }
        .login-box button { width: 100%; padding: 16px; border: none; background: linear-gradient(90deg, #d4af37, #b8860b); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; }

        .layout { display: none; min-height: 100vh; }
        .sidebar { width: 250px; background: #ffffff; border-right: 1px solid rgba(212,175,55,0.25); padding: 40px 25px; position: fixed; height: 100vh; }
        .sidebar a { display: block; padding: 12px 0; cursor: pointer; }
        .main { margin-left: 300px; padding: 50px; }

        table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #d4af37; }

        .search-input { width: 100%; padding: 10px; margin-top: 10px; }
        .btn { padding: 8px 14px; margin: 5px; cursor: pointer; border: none; border-radius: 6px; }
        .btn-sync { background: #3483fa; color: white; }
    </style>
</head>

<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>MARROKING SHOP</h2>
        <input id="username" placeholder="Usuario">
        <input id="password" type="password" placeholder="ContraseÃ±a">
        <button onclick="login()">ACCEDER</button>
    </div>
</div>

<!-- DASHBOARD -->
<div class="layout" id="dashboardLayout">
    <div class="sidebar">
        <h3 style="color:#d4af37;">MENÃš</h3>
        <a onclick="loadProducts()">Inventario ML</a>
        <a onclick="logout()">Cerrar sesiÃ³n</a>
    </div>

    <div class="main">
        <div id="inventario">
            <h2>Inventario Mercado Libre</h2>

            <button class="btn btn-sync" onclick="syncML()">ðŸ”„ Sincronizar</button>

            <input id="searchInput" class="search-input" placeholder="Buscar producto..." onkeyup="applyFilters()">

            <div>
                <button class="btn" onclick="setStatusFilter('all')">Todas</button>
                <button class="btn" onclick="setStatusFilter('active')">Activas</button>
                <button class="btn" onclick="setStatusFilter('paused')">Pausadas/Cerradas</button>
                <button class="btn" onclick="setStatusFilter('nostock')">Sin stock</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>ML ID</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const API = "https://marrokingcshop-api.onrender.com";

let allProducts = [];
let currentStatusFilter = "all";

// ===== AUTO LOGIN =====
window.onload = function(){
    const token = localStorage.getItem("token");
    if(token){
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardLayout").style.display = "flex";
        loadProducts();
    }
};

// ===== LOGIN =====
window.login = async function () {
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const resp = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
        })
    });

    const data = await resp.json();
    if (data.access_token) {
        localStorage.setItem("token", data.access_token);
        location.reload();
    } else {
        alert("Credenciales invÃ¡lidas");
    }
};

// ===== CARGAR PRODUCTOS =====
async function loadProducts(){
    // Limpiamos la tabla antes de cargar para evitar ver datos viejos
    document.getElementById("productTable").innerHTML = "<tr><td colspan='4'>Cargando datos frescos...</td></tr>";
    
    try {
        const resp = await fetch(API + "/products-grouped", {
            headers:{
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        });

        const data = await resp.json();
        console.log("DATOS RECIBIDOS:", data);
        allProducts = data.products || [];
        applyFilters();
    } catch (error) {
        console.error("Error al cargar:", error);
        alert("Error al conectar con el servidor");
    }
}

// ===== FILTROS (REVISADO PARA QUITAR STOCK 0 DE ACTIVAS) =====
function setStatusFilter(status){
    currentStatusFilter = status;
    applyFilters();
}

function applyFilters(){
    const searchInput = document.getElementById("searchInput");
    const text = (searchInput.value || "").toLowerCase().trim();

    let filtered = [...allProducts];

    // FILTRO DE ESTADO INTELIGENTE
    if(currentStatusFilter === "active"){
        // SOLO lo que sea 'active' Y tenga stock mayor a 0
        filtered = filtered.filter(p => {
            let total = 0;
            (p.variations || []).forEach(v => total += v.stock);
            return p.status === "active" && total > 0;
        });
    } 
    else if(currentStatusFilter === "paused"){
        // Todo lo que NO sea active (pausadas, cerradas, etc.)
        filtered = filtered.filter(p => p.status !== "active");
    } 
    else if(currentStatusFilter === "nostock"){
        // TODO lo que tenga stock 0, sin importar si MELI dice que estÃ¡ activa o no
        filtered = filtered.filter(p => {
            let total = 0;
            (p.variations || []).forEach(v => total += v.stock);
            return total === 0;
        });
    }
    
    // Filtro de texto (esto se queda igual abajo)
    if(text){
        filtered = filtered.filter(p =>
            (p.title || "").toLowerCase().includes(text) ||
            (p.variations || []).some(v => (v.name || "").toLowerCase().includes(text))
        );
    }

    renderTable(filtered);
}

// ===== RENDERIZAR TABLA =====
function renderTable(productsList){
    const table = document.getElementById("productTable");
    table.innerHTML = ""; 

    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>No se encontraron productos</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    productsList.forEach(item => {
        const hasVariations = item.variations && item.variations.length > 0;
        const status = (item.status || "").toLowerCase();
        let rowStyle = status !== "active" ? "background:#f9f9f9; color:#666;" : "";

        // CASO 1: Es un producto SENCILLO (Sin variantes)
        if (!hasVariations) {
            table.innerHTML += `
                <tr style="${rowStyle}">
                    <td><strong>${item.title}</strong></td>
                    <td>$${item.price || 0}</td>
                    <td style="font-weight:bold; color:${item.stock === 0 ? 'red' : 'green'};">${item.stock}</td>
                    <td style="font-family:monospace; font-size:12px;">${item.meli_item_id || item.meli_id || ""}</td>
                </tr>
            `;
        } 
        // CASO 2: Tiene VARIANTES (Ocultamos el total verde y solo mostramos el desglose)
        else {
            item.variations.forEach(v => {
                table.innerHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding-left:15px;">â”” ${v.name}</td>
                        <td>$${v.price || item.price || 0}</td>
                        <td style="font-weight:bold; color:${v.stock === 0 ? 'red' : 'black'};">${v.stock}</td>
                        <td style="font-family:monospace; font-size:11px;">${v.meli_id}</td>
                    </tr>
                `;
            });
        }
    });
}

// ===== SINCRONIZAR =====
async function syncML(){
    const btn = document.querySelector(".btn-sync");
    const originalText = btn.innerHTML;
    btn.innerHTML = "âŒ› Sincronizando...";
    btn.disabled = true;

    try {
        const resp = await fetch(API + "/meli/sync", {
            method:"POST",
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        if(resp.ok){
            alert("Â¡SincronizaciÃ³n Profunda Exitosa! Los datos se han actualizado.");
            await loadProducts();
        } else {
            alert("Error en el servidor al sincronizar");
        }
    } catch (e) {
        alert("Error de conexiÃ³n");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// ===== LOGOUT =====
function logout(){
    localStorage.clear();
    location.reload();
}
</script>

</body>
</html> 