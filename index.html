<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marroking Shop - Sistema Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f4f6f9; }
        .login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffffff; }
        .login-box { padding: 60px; border-radius: 18px; border: 1px solid rgba(212,175,55,0.25); box-shadow: 0 30px 60px rgba(0,0,0,0.06); width: 400px; text-align: center; }
        .login-box input { width: 100%; padding: 16px; margin-bottom: 22px; border: 1px solid #e5e7eb; border-radius: 12px; }
        .login-box button { width: 100%; padding: 16px; border: none; background: linear-gradient(90deg, #d4af37, #b8860b); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; }

        .layout { display: none; min-height: 100vh; }
        .sidebar { width: 250px; background: #ffffff; border-right: 1px solid rgba(212,175,55,0.25); padding: 40px 25px; position: fixed; height: 100vh; }
        .sidebar a { display: block; padding: 12px 0; cursor: pointer; color: #333; text-decoration: none;}
        .sidebar a:hover { color: #d4af37; }
        .main { margin-left: 300px; padding: 50px; width: 100%;}

        table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        th, td { padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #d4af37; text-align: left; }

        .search-input { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 8px 14px; margin: 5px; cursor: pointer; border: none; border-radius: 6px; }
        .btn-sync { background: #3483fa; color: white; }
        .btn-warning { background: #ffc107; color: #000; font-weight: bold; }
    </style>
</head>

<body>

<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>MARROKING SHOP</h2>
        <input id="username" placeholder="Usuario">
        <input id="password" type="password" placeholder="Contrase√±a">
        <button onclick="login()">ACCEDER</button>
    </div>
</div>

<div class="layout" id="dashboardLayout">
    <div class="sidebar">
        <h3 style="color:#d4af37;">MEN√ö</h3>
        <a onclick="showSection('inventario')">üì¶ Inventario ML</a>
        <a onclick="showSection('editarStock')">‚úèÔ∏è Editar Stock</a>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        <a onclick="logout()" style="color: red;">Cerrar sesi√≥n</a>
    </div>

    <div class="main">
        <div id="inventario">
            <h2>Inventario Mercado Libre</h2>

            <button class="btn btn-sync" onclick="syncML()">üîÑ Sincronizar</button>
            <button class="btn btn-warning" onclick="window.location.href='https://auth.mercadolibre.com.mx/authorization?response_type=code&client_id=8753239463972688&redirect_uri=https://marrokingcshop-api.onrender.com/auth/callback'">üîë Renovar / Vincular MELI</button>

            <input id="searchInput" class="search-input" placeholder="Buscar producto..." onkeyup="applyFilters()">

            <div style="margin-top: 15px;">
                <button class="btn" style="background:#eee" onclick="setStatusFilter('all')">Todas</button>
                <button class="btn" style="background:#e6f4ea; color:#137333;" onclick="setStatusFilter('active')">Activas</button>
                <button class="btn" style="background:#fce8e6; color:#c5221f;" onclick="setStatusFilter('paused')">Pausadas/Cerradas</button>
                <button class="btn" style="background:#fef7e0; color:#b06000;" onclick="setStatusFilter('nostock')">Sin stock</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>ML ID</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>

        <div id="editarStock" style="display:none;">
            <h2>Control y Edici√≥n de Stock</h2>
            <p style="color: gray; margin-bottom: 20px;">Los cambios realizados aqu√≠ se reflejar√°n directamente en Mercado Libre.</p>

            <input id="searchStockInput" class="search-input" placeholder="üîç Buscar producto por nombre o ID..." onkeyup="filterStock()">

            <table>
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">Foto</th>
                        <th>Producto / Talla</th>
                        <th>ID MELI</th>
                        <th style="text-align:center;">Stock Actual</th>
                        <th style="text-align:center;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="stockEditorTable">
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
const API = "https://marrokingcshop-api.onrender.com";

let allProducts = [];
let currentStatusFilter = "all";
let searchTimeout; // Variable para que la b√∫squeda sea fluida

function showSection(sectionId) {
    document.getElementById('inventario').style.display = 'none';
    document.getElementById('editarStock').style.display = 'none';
    document.getElementById(sectionId).style.display = 'block';
}

window.onload = function(){
    const token = localStorage.getItem("token");
    if(token){
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardLayout").style.display = "flex";
        loadProducts();
    }
};

window.login = async function () {
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const resp = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
        })
    });

    const data = await resp.json();
    if (data.access_token) {
        localStorage.setItem("token", data.access_token);
        location.reload();
    } else {
        alert("Credenciales inv√°lidas");
    }
};

async function loadProducts(){
    document.getElementById("productTable").innerHTML = "<tr><td colspan='4'>Cargando datos frescos...</td></tr>";
    document.getElementById("stockEditorTable").innerHTML = "<tr><td colspan='5'>Cargando datos frescos...</td></tr>";
    
    try {
        const resp = await fetch(API + "/products-grouped", {
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        const data = await resp.json();
        allProducts = data.products || [];
        
        applyFilters(); 
        renderStockTable(allProducts); 
        
    } catch (error) {
        alert("Error al conectar con el servidor");
    }
}

function setStatusFilter(status){
    currentStatusFilter = status;
    applyFilters();
}

function applyFilters(){
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchInput = document.getElementById("searchInput");
        const text = (searchInput.value || "").toLowerCase().trim();
        let filtered = [...allProducts];

        if(currentStatusFilter === "active"){
            filtered = filtered.filter(p => p.status === "active" && p.stock > 0);
        } 
        else if(currentStatusFilter === "paused"){
            filtered = filtered.filter(p => p.status !== "active");
        } 
        else if(currentStatusFilter === "nostock"){
            filtered = filtered.filter(p => p.stock === 0);
        }
        
        if(text){
            filtered = filtered.filter(p => (p.title || "").toLowerCase().includes(text));
        }

        renderTable(filtered);
    }, 300); // 300ms de retraso para que no se trabe al escribir
}

function renderTable(productsList){
    const table = document.getElementById("productTable");
    table.innerHTML = ""; 

    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>No se encontraron productos</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    // Optimizaci√≥n: armar HTML en memoria para la tabla de inventario
    let htmlContent = "";
    productsList.forEach(item => {
        const status = (item.status || "").toLowerCase();
        let rowStyle = status !== "active" ? "background:#f9f9f9; color:#666;" : "";

        htmlContent += `
            <tr style="${rowStyle}">
                <td><strong>${item.title}</strong></td>
                <td>$${item.price || 0}</td>
                <td style="font-weight:bold; color:${item.stock === 0 ? 'red' : 'green'};">${item.stock}</td>
                <td style="font-family:monospace; font-size:12px;">${item.meli_item_id || ""}</td>
            </tr>
        `;
    });
    table.innerHTML = htmlContent;
}

// =========================================================
// NUEVA RENDERIZACI√ìN DE TABLA AGRUPADA (ESTILO MELI) - OPTIMIZADA
// =========================================================
function renderStockTable(productsList) {
    const table = document.getElementById("stockEditorTable");
    
    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>No se encontraron productos</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    // 1. Agrupar productos por Publicaci√≥n "Padre"
    const grouped = {};
    productsList.forEach(p => {
        let parentId = p.meli_item_id;
        if (p.meli_item_id.includes("-")) {
            parentId = p.meli_item_id.split("-")[0];
        }

        if (!grouped[parentId]) {
            let mainTitle = p.title.split("(")[0].trim(); // T√≠tulo general sin la talla
            grouped[parentId] = {
                parentId: parentId,
                title: mainTitle,
                thumbnail: p.thumbnail,
                totalStock: 0,
                variations: []
            };
        }
        grouped[parentId].variations.push(p);
        grouped[parentId].totalStock += (p.stock || 0);
    });

    // 2. Variable para almacenar todo el HTML en memoria antes de inyectarlo (EVITA QUE SE TRABE)
    let finalHTML = "";

    // 3. Dibujar las filas padre y sus variantes hijas
    for (let parentId in grouped) {
        const group = grouped[parentId];
        let photo = group.thumbnail ? `<img src="${group.thumbnail}" style="width:40px; height:40px; border-radius:4px; object-fit:cover; border: 1px solid #ccc;">` : "üì∑";

        // --- FILA PRINCIPAL (PADRE) ---
        finalHTML += `
            <tr style="background-color: #f8f9fa; cursor: pointer; border-bottom: 2px solid #dee2e6; transition: 0.2s;" onclick="toggleVariations('${parentId}')" onmouseover="this.style.background='#f1f3f5'" onmouseout="this.style.background='#f8f9fa'">
                <td style="text-align:center;">${photo}</td>
                <td style="font-weight:bold; color: #333; font-size: 1.05em; padding: 15px;">üìÅ ${group.title}</td>
                <td style="font-family:monospace; font-size:12px; color:gray;">${parentId}</td>
                <td style="text-align:center; font-size:18px; font-weight:bold; color:#d4af37;">
                    ${group.totalStock} <span style="font-size:12px; font-weight:normal; color:#666; display:block;">unidades en total</span>
                </td>
                <td style="text-align:center;">
                    <button style="background:none; border:none; color:#3483fa; font-weight:bold; cursor:pointer; font-size:14px;">
                        Ver ${group.variations.length} variantes ‚ñº
                    </button>
                </td>
            </tr>
        `;

        // --- FILA OCULTA CON LAS VARIANTES (HIJAS) ---
        let childRows = `<tr id="vars-${parentId}" style="display:none;">
                            <td colspan="5" style="padding:0; background:#fff;">
                                <table style="width:100%; border-collapse:collapse; margin:0; background:#fdfdfd;">`;
        
        group.variations.forEach(v => {
            let varDetail = v.title.includes("(") ? v.title.substring(v.title.indexOf("(")) : "(√önico)";
            
            childRows += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="width:50px; text-align:right; color:#bbb;">‚Ü≥</td>
                    <td style="padding:15px; color:#555; font-weight:600;">${varDetail}</td>
                    <td style="font-family:monospace; font-size:12px; color:#888;">${v.meli_item_id}</td>
                    <td style="text-align:center; font-size:18px; font-weight:bold;">
                        <span id="stock-val-${v.meli_item_id}">${v.stock}</span>
                    </td>
                    <td style="text-align:center; padding:10px;">
                        <button onclick="changeStock('${v.meli_item_id}', -1)" style="padding:6px 14px; font-size:16px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;">-</button>
                        <button onclick="changeStock('${v.meli_item_id}', 1)" style="padding:6px 14px; font-size:16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; margin-right:15px;">+</button>
                        <button onclick="saveStockToMeli('${v.meli_item_id}')" style="padding:8px 15px; background:#3483fa; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; width:150px;">üíæ Guardar</button>
                    </td>
                </tr>
            `;
        });
        childRows += `</table></td></tr>`;
        finalHTML += childRows;
    }

    // 4. Inyectar todo al HTML en un solo movimiento (ESTO EVITA QUE SE TRABE)
    table.innerHTML = finalHTML;
}

// Funci√≥n para abrir y cerrar las variantes
function toggleVariations(parentId) {
    const row = document.getElementById(`vars-${parentId}`);
    if (row.style.display === "none") {
        row.style.display = "table-row";
    } else {
        row.style.display = "none";
    }
}

function changeStock(id, amount) {
    let span = document.getElementById(`stock-val-${id}`);
    let current = parseInt(span.innerText);
    let newStock = current + amount;
    if (newStock < 0) newStock = 0; 
    span.innerText = newStock;
}

async function saveStockToMeli(id) {
    let span = document.getElementById(`stock-val-${id}`);
    let newStock = parseInt(span.innerText);
    let token = localStorage.getItem("token");

    let btn = event.target;
    let originalText = btn.innerText;
    btn.innerText = "‚è≥ Guardando...";
    btn.disabled = true;
    btn.style.background = "#ccc";

    try {
        let response = await fetch(`${API}/meli/update_stock/${id}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ new_stock: newStock })
        });

        if (response.ok) {
            alert("‚úÖ ¬°Stock actualizado en Mercado Libre!");
            let prod = allProducts.find(p => p.meli_item_id === id);
            if(prod) prod.stock = newStock;
            
            // Recargamos silenciosamente los datos para actualizar el "Stock Total" del padre
            loadProducts();
        } else {
            let errData = await response.json();
            alert("‚ùå Error de MELI: " + (errData.detail || "Error desconocido"));
        }
    } catch (error) {
        alert("‚ùå Error de conexi√≥n");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        btn.style.background = "#3483fa";
    }
}

function filterStock() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        let text = document.getElementById("searchStockInput").value.toLowerCase();
        let filtered = allProducts.filter(p => 
            (p.title || "").toLowerCase().includes(text) || 
            (p.meli_item_id || "").toLowerCase().includes(text)
        );
        renderStockTable(filtered);
    }, 300);
}

async function syncML(){
    const btn = document.querySelector(".btn-sync");
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚åõ Sincronizando...";
    btn.disabled = true;

    try {
        const resp = await fetch(API + "/meli/sync", {
            method:"POST",
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        if(resp.ok){
            alert("¬°Sincronizaci√≥n Exitosa! Datos actualizados.");
            await loadProducts();
        } else {
            alert("Error en el servidor al sincronizar");
        }
    } catch (e) {
        alert("Error de conexi√≥n");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function logout(){
    localStorage.clear();
    location.reload();
}
</script>

</body>
</html>