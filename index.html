<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marroking Shop - Sistema Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gold: #cfa862;
            --primary-gold-dark: #b89657;
            --corporate-blue: #2c3e50;
            --bg-light: #f8f9fc;
            --text-dark: #2d3436;
            --text-gray: #636e72;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text-dark); }
        
        /* Login Screen - M√°s moderno */
        .login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffffff; }
        .login-box { padding: 50px; border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.08); width: 420px; text-align: center; }
        .login-box h2 { color: var(--corporate-blue); font-weight: 700; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 18px; margin-bottom: 20px; border: 1px solid #dfe6e9; border-radius: 12px; font-size: 16px; background: #fdfdfd; }
        .login-box button { width: 100%; padding: 18px; border: none; background: var(--corporate-blue); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .login-box button:hover { background: #34495e; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); }

        /* Layout Principal */
        .layout { display: none; min-height: 100vh; }
        .sidebar { width: 280px; background: #ffffff; border-right: 1px solid #edf2f7; padding: 40px 30px; position: fixed; height: 100vh; box-shadow: 5px 0 15px rgba(0,0,0,0.02); }
        .sidebar h3 { color: var(--primary-gold); font-weight: 700; letter-spacing: 1px; margin-bottom: 30px; }
        .sidebar a { display: block; padding: 15px; margin-bottom: 10px; cursor: pointer; color: var(--text-gray); text-decoration: none; font-weight: 600; border-radius: 10px; transition: 0.2s; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary-gold); background: #fffbf4; }
        .main { margin-left: 330px; padding: 50px; width: calc(100% - 330px); }
        .main h2 { font-size: 28px; font-weight: 700; color: var(--corporate-blue); margin-bottom: 25px; }

        /* Componentes Corporativos */
        .search-input { width: 100%; padding: 15px 20px; margin-top: 15px; border: 1px solid #dfe6e9; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .btn { padding: 12px 20px; margin: 8px; cursor: pointer; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .btn-sync { background: var(--corporate-blue); color: white; }
        .btn-warning { background: var(--primary-gold); color: white; }
        .filter-btn { background: white; border: 1px solid #dfe6e9; color: var(--text-gray); }
        .filter-btn.active { background: var(--primary-gold); color: white; border-color: var(--primary-gold); }

        /* Tablas Profesionales */
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; margin-top: 25px; }
        th { padding: 15px 20px; color: var(--text-gray); font-weight: 600; text-align: left; border-bottom: 2px solid #edf2f7; text-transform: uppercase; font-size: 13px; letter-spacing: 1px; }
        td { padding: 20px; background: white; border-top: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
        tr:first-child td { border-top: none; }
        tr td:first-child { border-left: 1px solid #edf2f7; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        tr td:last-child { border-right: 1px solid #edf2f7; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        tbody tr { box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.2s; }
        tbody tr:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }

        /* Estilos espec√≠ficos para la tabla de Stock */
        .parent-row { cursor: pointer; background: white; }
        .parent-row:hover { background: #fefefe !important; }
        .product-thumb { width: 100px; height: 100px; border-radius: 12px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .parent-title { font-size: 18px; font-weight: 700; color: var(--corporate-blue); display: flex; align-items: center; }
        .parent-title span { margin-left: 10px; }
        .total-stock { font-size: 22px; font-weight: 700; color: var(--primary-gold); }
        .total-stock small { font-size: 13px; font-weight: 400; color: var(--text-gray); display: block; }
        .view-variants-btn { background: none; border: none; color: var(--primary-gold); font-weight: 700; cursor: pointer; font-size: 15px; display: flex; align-items: center; }
        .view-variants-btn i { margin-left: 8px; transition: 0.3s; }

        /* Tabla de Variantes (Hija) */
        .child-container { background: #f8f9fc !important; box-shadow: inset 0 5px 15px rgba(0,0,0,0.03) !important; padding: 0 !important; }
        .child-table { width: 100%; border-collapse: collapse; background: transparent; box-shadow: none; border-spacing: 0; margin-top: 0; }
        .child-table td { background: transparent; border: none; border-bottom: 1px solid #e0e6ed; padding: 18px; }
        .child-table tr:last-child td { border-bottom: none; }
        .variant-title { font-weight: 600; color: var(--text-dark); font-size: 15px; }
        .stock-control { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .stock-val { font-size: 20px; font-weight: 700; min-width: 40px; text-align: center; }
        .btn-qty { width: 40px; height: 40px; border-radius: 50%; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-minus { background: #ff7675; color: white; }
        .btn-plus { background: #55efc4; color: white; }
        .btn-qty:hover { transform: scale(1.1); }
        .btn-save { background: var(--corporate-blue); color: white; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; max-width: 180px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-save:hover { background: var(--primary-gold); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>MARROKING SHOP PRO</h2>
        <input id="username" placeholder="Usuario">
        <input id="password" type="password" placeholder="Contrase√±a">
        <button onclick="login()">INICIAR SESI√ìN</button>
    </div>
</div>

<div class="layout" id="dashboardLayout">
    <div class="sidebar">
        <h3>MEN√ö PRINCIPAL</h3>
        <a onclick="showSection('inventario')" id="link-inventario" class="active"><i class="fas fa-box-open" style="margin-right:10px;"></i> Inventario ML</a>
        <a onclick="showSection('editarStock')" id="link-editarStock"><i class="fas fa-edit" style="margin-right:10px;"></i> Control de Stock</a>
        <hr style="border:0; border-top:1px solid #edf2f7; margin: 30px 0;">
        <a onclick="logout()" style="color: #d63031;"><i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Cerrar sesi√≥n</a>
    </div>

    <div class="main">
        <div id="inventario">
            <h2>Inventario General de Mercado Libre</h2>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-sync" onclick="syncML()"><i class="fas fa-sync-alt"></i> Sincronizar Ahora</button>
                <button class="btn btn-warning" onclick="window.location.href='https://auth.mercadolibre.com.mx/authorization?response_type=code&client_id=8753239463972688&redirect_uri=https://marrokingcshop-api.onrender.com/auth/callback'"><i class="fas fa-key"></i> Vincular Cuenta MELI</button>
            </div>

            <input id="searchInput" class="search-input" placeholder="üîç Buscar producto por nombre, ID o SKU..." onkeyup="applyFilters()">

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn filter-btn active" onclick="setStatusFilter('all', this)">Todas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('active', this)"><i class="fas fa-check-circle" style="color:#55efc4;"></i> Activas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('paused', this)"><i class="fas fa-pause-circle" style="color:#fab1a0;"></i> Pausadas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('nostock', this)"><i class="fas fa-times-circle" style="color:#ff7675;"></i> Sin Stock</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="padding-left: 30px;">Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>ID MELI</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>

        <div id="editarStock" style="display:none;">
            <h2>Control de Stock Corporativo</h2>
            <p style="color: var(--text-gray); margin-bottom: 30px; font-size: 15px;">Gestione el inventario de sus publicaciones agrupadas. Los cambios se reflejan en tiempo real en Mercado Libre.</p>

            <input id="searchStockInput" class="search-input" placeholder="üîç Buscar publicaci√≥n..." onkeyup="filterStock()">

            <table style="border-spacing: 0 15px;">
                <thead>
                    <tr>
                        <th style="width: 120px; text-align: center;">Imagen</th>
                        <th>Publicaci√≥n "Padre"</th>
                        <th>ID General</th>
                        <th style="text-align:center;">Inventario Total</th>
                        <th style="text-align:center;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="stockEditorTable">
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
const API = "https://marrokingcshop-api.onrender.com";

let allProducts = [];
let currentStatusFilter = "all";
let searchTimeout;

function showSection(sectionId) {
    document.getElementById('inventario').style.display = 'none';
    document.getElementById('editarStock').style.display = 'none';
    document.getElementById(sectionId).style.display = 'block';

    // Actualizar clase active en el men√∫
    document.getElementById('link-inventario').classList.remove('active');
    document.getElementById('link-editarStock').classList.remove('active');
    document.getElementById('link-' + sectionId).classList.add('active');
}

window.onload = function(){
    const token = localStorage.getItem("token");
    if(token){
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardLayout").style.display = "flex";
        loadProducts();
    }
};

window.login = async function () {
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const resp = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
        })
    });

    const data = await resp.json();
    if (data.access_token) {
        localStorage.setItem("token", data.access_token);
        location.reload();
    } else {
        alert("Credenciales inv√°lidas");
    }
};

async function loadProducts(){
    document.getElementById("productTable").innerHTML = "<tr><td colspan='4' style='text-align:center; padding:30px; color:var(--text-gray);'><i class='fas fa-spinner fa-spin'></i> Cargando inventario...</td></tr>";
    document.getElementById("stockEditorTable").innerHTML = "<tr><td colspan='5' style='text-align:center; padding:30px; color:var(--text-gray);'><i class='fas fa-spinner fa-spin'></i> Cargando publicaciones...</td></tr>";
    
    try {
        const resp = await fetch(API + "/products-grouped", {
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        const data = await resp.json();
        allProducts = data.products || [];
        
        applyFilters(); 
        renderStockTable(allProducts); 
        
    } catch (error) {
        alert("Error al conectar con el servidor");
    }
}

function setStatusFilter(status, btnElement){
    currentStatusFilter = status;
    // Actualizar estado visual de los botones de filtro
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');
    applyFilters();
}

function applyFilters(){
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchInput = document.getElementById("searchInput");
        const text = (searchInput.value || "").toLowerCase().trim();
        let filtered = [...allProducts];

        if(currentStatusFilter === "active"){
            filtered = filtered.filter(p => p.status === "active" && p.stock > 0);
        } 
        else if(currentStatusFilter === "paused"){
            filtered = filtered.filter(p => p.status !== "active");
        } 
        else if(currentStatusFilter === "nostock"){
            filtered = filtered.filter(p => p.stock === 0);
        }
        
        if(text){
            filtered = filtered.filter(p => (p.title || "").toLowerCase().includes(text));
        }

        renderTable(filtered);
    }, 300);
}

function renderTable(productsList){
    const table = document.getElementById("productTable");
    table.innerHTML = ""; 

    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:40px; color:var(--text-gray);'><i class='fas fa-search' style='font-size:24px; margin-bottom:10px;'></i><br>No se encontraron productos</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    let htmlContent = "";
    productsList.forEach(item => {
        const status = (item.status || "").toLowerCase();
        let rowStyle = status !== "active" ? "opacity: 0.6; background:#f8f9fc;" : "";
        let stockColor = item.stock === 0 ? '#ff7675' : '#55efc4';
        let stockIcon = item.stock === 0 ? 'times-circle' : 'check-circle';

        htmlContent += `
            <tr style="${rowStyle}">
                <td style="padding-left: 30px;"><strong>${item.title}</strong></td>
                <td style="font-weight:600; color:var(--corporate-blue);">$${item.price || 0}</td>
                <td style="font-weight:bold; color:${stockColor};"><i class="fas fa-${stockIcon}"></i> ${item.stock}</td>
                <td style="font-family:monospace; font-size:12px; color:var(--text-gray);">${item.meli_item_id || ""}</td>
            </tr>
        `;
    });
    table.innerHTML = htmlContent;
}

// =========================================================
// NUEVA RENDERIZACI√ìN VISUAL MEJORADA (CORPORATIVA)
// =========================================================
function renderStockTable(productsList) {
    const table = document.getElementById("stockEditorTable");
    
    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px; color:var(--text-gray);'><i class='fas fa-box-open' style='font-size:30px; margin-bottom:15px;'></i><br>No hay publicaciones para mostrar</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    const grouped = {};
    productsList.forEach(p => {
        let parentId = p.meli_item_id;
        if (p.meli_item_id.includes("-")) {
            parentId = p.meli_item_id.split("-")[0];
        }

        if (!grouped[parentId]) {
            let mainTitle = p.title.split("(")[0].trim();
            grouped[parentId] = {
                parentId: parentId,
                title: mainTitle,
                thumbnail: p.thumbnail,
                totalStock: 0,
                variations: []
            };
        }
        grouped[parentId].variations.push(p);
        grouped[parentId].totalStock += (p.stock || 0);
    });

    let finalHTML = "";

    for (let parentId in grouped) {
        const group = grouped[parentId];
        let photo = group.thumbnail ? `<img src="${group.thumbnail}" class="product-thumb">` : "<div class='product-thumb' style='display:flex;align-items:center;justify-content:center;background:#eee;color:#aaa;'><i class='fas fa-camera fa-2x'></i></div>";

        // --- FILA PADRE (DISE√ëO MEJORADO) ---
        finalHTML += `
            <tr class="parent-row" onclick="toggleVariations('${parentId}', this)">
                <td style="text-align:center; padding: 15px;">${photo}</td>
                <td>
                    <div class="parent-title"><i class="fas fa-folder" style="color:var(--primary-gold);"></i> <span>${group.title}</span></div>
                </td>
                <td style="font-family:monospace; font-size:13px; color:var(--text-gray);">${parentId}</td>
                <td style="text-align:center;">
                    <div class="total-stock">
                        ${group.totalStock}
                        <small>unidades</small>
                    </div>
                </td>
                <td style="text-align:center;">
                    <button class="view-variants-btn">
                        Ver ${group.variations.length} variantes <i class="fas fa-chevron-down"></i>
                    </button>
                </td>
            </tr>
        `;

        // --- FILA HIJA (DISE√ëO LIMPIO Y MODERNO) ---
        let childRows = `<tr id="vars-${parentId}" style="display:none;">
                            <td colspan="5" class="child-container">
                                <table class="child-table">`;
        
        group.variations.forEach(v => {
            let varDetail = v.title.includes("(") ? v.title.substring(v.title.indexOf("(")) : "(Versi√≥n √önica)";
            
            childRows += `
                <tr>
                    <td style="width:60px; text-align:center; color:#ccc;"><i class="fas fa-level-up-alt fa-rotate-90"></i></td>
                    <td>
                        <div class="variant-title">${varDetail}</div>
                        <div style="font-family:monospace; font-size:11px; color:#aaa; margin-top:5px;">${v.meli_item_id}</div>
                    </td>
                    <td></td> <td>
                        <div class="stock-control">
                            <button class="btn-qty btn-minus" onclick="changeStock('${v.meli_item_id}', -1)"><i class="fas fa-minus"></i></button>
                            <span id="stock-val-${v.meli_item_id}" class="stock-val">${v.stock}</span>
                            <button class="btn-qty btn-plus" onclick="changeStock('${v.meli_item_id}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </td>
                    <td style="text-align:center;">
                        <button class="btn-save" onclick="saveStockToMeli('${v.meli_item_id}')">
                            <i class="fas fa-cloud-upload-alt" style="margin-right:8px;"></i> Guardar Stock
                        </button>
                    </td>
                </tr>
            `;
        });
        childRows += `</table></td></tr>`;
        finalHTML += childRows;
    }

    table.innerHTML = finalHTML;
}

// Funci√≥n para abrir y cerrar las variantes con animaci√≥n de icono
function toggleVariations(parentId, rowElement) {
    const row = document.getElementById(`vars-${parentId}`);
    const icon = rowElement.querySelector('.view-variants-btn i');
    
    if (row.style.display === "none") {
        row.style.display = "table-row";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        rowElement.style.background = "#f1f3f5";
    } else {
        row.style.display = "none";
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        rowElement.style.background = "white";
    }
}

function changeStock(id, amount) {
    let span = document.getElementById(`stock-val-${id}`);
    let current = parseInt(span.innerText);
    let newStock = current + amount;
    if (newStock < 0) newStock = 0; 
    span.innerText = newStock;
}

async function saveStockToMeli(id) {
    let span = document.getElementById(`stock-val-${id}`);
    let newStock = parseInt(span.innerText);
    let token = localStorage.getItem("token");

    let btn = event.target.closest('button');
    let originalHTML = btn.innerHTML;
    btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Guardando...";
    btn.disabled = true;
    btn.style.background = "#b2bec3";

    try {
        let response = await fetch(`${API}/meli/update_stock/${id}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ new_stock: newStock })
        });

        if (response.ok) {
            // Usamos un toast o alerta m√°s bonita si pudieras, por ahora alerta nativa
            alert("‚úÖ Stock actualizado correctamente en Mercado Libre.");
            let prod = allProducts.find(p => p.meli_item_id === id);
            if(prod) prod.stock = newStock;
            loadProducts();
        } else {
            let errData = await response.json();
            alert("‚ö†Ô∏è Mercado Libre report√≥ un problema: " + (errData.detail || "Error desconocido"));
        }
    } catch (error) {
        alert("‚ùå No se pudo conectar con el servidor.");
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        btn.style.background = "var(--corporate-blue)";
    }
}

function filterStock() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        let text = document.getElementById("searchStockInput").value.toLowerCase();
        let filtered = allProducts.filter(p => 
            (p.title || "").toLowerCase().includes(text) || 
            (p.meli_item_id || "").toLowerCase().includes(text)
        );
        renderStockTable(filtered);
    }, 300);
}

async function syncML(){
    const btn = document.querySelector(".btn-sync");
    const originalHTML = btn.innerHTML;
    btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Sincronizando...";
    btn.disabled = true;

    try {
        const resp = await fetch(API + "/meli/sync", {
            method:"POST",
            headers:{ "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        if(resp.ok){
            alert("‚úÖ Sincronizaci√≥n completada con √©xito.");
            await loadProducts();
        } else {
            alert("‚ùå Hubo un problema al sincronizar con el servidor.");
        }
    } catch (e) {
        alert("‚ùå Error de conexi√≥n.");
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

function logout(){
    if(confirm("¬øEst√°s seguro de que deseas cerrar sesi√≥n?")){
        localStorage.clear();
        location.reload();
    }
}
</script>

</body>
</html>