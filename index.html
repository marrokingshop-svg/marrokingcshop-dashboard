<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marroking Shop - Sistema Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gold: #cfa862;
            --primary-gold-dark: #b89657;
            --corporate-blue: #2c3e50;
            --bg-light: #f8f9fc;
            --text-dark: #2d3436;
            --text-gray: #636e72;
        }

        * { box-sizing: border-box; } 

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text-dark); }
        
        /* Login Screen */
        .login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffffff; }
        .login-box { padding: 50px; border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.08); width: 420px; text-align: center; }
        .login-box h2 { color: var(--corporate-blue); font-weight: 700; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 18px; margin-bottom: 20px; border: 1px solid #dfe6e9; border-radius: 12px; font-size: 16px; background: #fdfdfd; }
        .login-box button { width: 100%; padding: 18px; border: none; background: var(--corporate-blue); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .login-box button:hover { background: #34495e; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); }

        /* Layout Principal */
        .layout { display: none; min-height: 100vh; }
        .sidebar { width: 220px; background: #ffffff; border-right: 1px solid #edf2f7; padding: 30px 15px; position: fixed; height: 100vh; box-shadow: 5px 0 15px rgba(0,0,0,0.02); }
        .sidebar h3 { color: var(--primary-gold); font-weight: 700; letter-spacing: 1px; margin-bottom: 30px; font-size: 14px; text-align: center; }
        .sidebar a { display: block; padding: 12px 15px; margin-bottom: 8px; cursor: pointer; color: var(--text-gray); text-decoration: none; font-weight: 600; border-radius: 10px; transition: 0.2s; font-size: 13px; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary-gold); background: #fffbf4; }
        
        .main { margin-left: 220px; padding: 40px; width: calc(100% - 220px); }
        .main h2 { font-size: 28px; font-weight: 700; color: var(--corporate-blue); margin-bottom: 25px; }

        /* Componentes Corporativos */
        .search-input { width: 100%; padding: 15px 20px; margin-top: 15px; border: 1px solid #dfe6e9; border-radius: 12px; font-size: 16px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .btn { padding: 12px 20px; margin: 8px; cursor: pointer; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .btn-sync { background: var(--corporate-blue); color: white; }
        .btn-warning { background: var(--primary-gold); color: white; }
        .filter-btn { background: white; border: 1px solid #dfe6e9; color: var(--text-gray); }
        .filter-btn.active { background: var(--primary-gold); color: white; border-color: var(--primary-gold); }

        /* Tablas Profesionales */
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; margin-top: 25px; }
        th { padding: 15px 15px; color: var(--text-gray); font-weight: 600; text-align: left; border-bottom: 2px solid #edf2f7; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        td { padding: 15px; background: white; border-top: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
        tr:first-child td { border-top: none; }
        tr td:first-child { border-left: 1px solid #edf2f7; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        tr td:last-child { border-right: 1px solid #edf2f7; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        tbody tr { box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.2s; }
        tbody tr:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }

        /* Estilos espec√≠ficos para la tabla de Stock */
        .parent-row { cursor: pointer; background: white; }
        .parent-row:hover { background: #fefefe !important; }
        .product-thumb { width: 85px; height: 85px; border-radius: 10px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .parent-title { font-size: 16px; font-weight: 700; color: var(--corporate-blue); display: flex; align-items: center; }
        .parent-title span { margin-left: 10px; }
        .total-stock { font-size: 20px; font-weight: 700; color: var(--primary-gold); }
        .total-stock small { font-size: 12px; font-weight: 400; color: var(--text-gray); display: block; }
        .view-variants-btn { background: none; border: none; color: var(--primary-gold); font-weight: 700; cursor: pointer; font-size: 14px; display: flex; align-items: center; }
        .view-variants-btn i { margin-left: 8px; transition: 0.3s; }

        /* Tabla de Variantes (Hija) */
        .child-container { background: #f8f9fc !important; box-shadow: inset 0 5px 15px rgba(0,0,0,0.03) !important; padding: 0 !important; }
        .child-table { width: 100%; border-collapse: collapse; background: transparent; box-shadow: none; border-spacing: 0; margin-top: 0; }
        .child-table td { background: transparent; border: none; border-bottom: 1px solid #e0e6ed; padding: 15px; }
        .child-table tr:last-child td { border-bottom: none; }
        .variant-title { font-weight: 600; color: var(--text-dark); font-size: 14px; }
        .stock-control { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .stock-val { font-size: 18px; font-weight: 700; min-width: 35px; text-align: center; }
        .btn-qty { width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-minus { background: #ff7675; color: white; }
        .btn-plus { background: #55efc4; color: white; }
        .btn-qty:hover { transform: scale(1.1); }
        .btn-save { background: var(--corporate-blue); color: white; padding: 10px 15px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; max-width: 150px; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 13px; }
        .btn-save:hover { background: var(--primary-gold); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>MARROKING SHOP PRO</h2>
        <input id="username" placeholder="Usuario">
        <input id="password" type="password" placeholder="Contrase√±a">
        <button onclick="login()">INICIAR SESI√ìN</button>
    </div>
</div>

<div class="layout" id="dashboardLayout">
    <div class="sidebar">
        <h3>MEN√ö PRINCIPAL</h3>
        <a onclick="showSection('inventario')" id="link-inventario" class="active"><i class="fas fa-box-open" style="margin-right:10px;"></i> Inventario ML</a>
        <a onclick="showSection('editarStock')" id="link-editarStock"><i class="fas fa-edit" style="margin-right:10px;"></i> Control de Stock</a>
        <a onclick="showSection('bovedaClaves')" id="link-bovedaClaves"><i class="fas fa-lock" style="margin-right:10px;"></i> B√≥veda de Claves</a>
        <hr style="border:0; border-top:1px solid #edf2f7; margin: 30px 0;">
        <a onclick="logout()" style="color: #d63031;"><i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Cerrar sesi√≥n</a>
    </div>

    <div class="main">
        <div id="inventario">
            <h2>Inventario General de Mercado Libre</h2>

            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                <button class="btn btn-sync" onclick="syncML()"><i class="fas fa-sync-alt"></i> Sincronizar Ahora</button>
                <button class="btn btn-warning" onclick="window.location.href='https://auth.mercadolibre.com.mx/authorization?response_type=code&client_id=2347232636874610&redirect_uri=https://marrokingcshop-api.onrender.com/auth/callback'"><i class="fas fa-key"></i> Vincular Cuenta MELI</button>
            </div>

            <div style="margin-bottom: 15px; padding-left: 8px;">
                <small id="last-update-time" style="color: #a0a0a0; font-size: 0.75rem; font-style: italic;"></small>
            </div>

            <input id="searchInput" class="search-input" placeholder="üîç Buscar producto por nombre, ID o SKU..." onkeyup="applyFilters()">

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn filter-btn active" onclick="setStatusFilter('all', this)">Todas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('active', this)"><i class="fas fa-check-circle" style="color:#55efc4;"></i> Activas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('paused', this)"><i class="fas fa-pause-circle" style="color:#fab1a0;"></i> Pausadas</button>
                <button class="btn filter-btn" onclick="setStatusFilter('nostock', this)"><i class="fas fa-times-circle" style="color:#ff7675;"></i> Sin Stock</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="padding-left: 30px;">Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>ID MELI</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>

        <div id="editarStock" style="display:none;">
            <h2>Control de Stock Corporativo</h2>
            <p style="color: var(--text-gray); margin-bottom: 30px; font-size: 15px;">Gestione el inventario de sus publicaciones agrupadas. Los cambios se reflejan en tiempo real en Mercado Libre.</p>

            <input id="searchStockInput" class="search-input" placeholder="üîç Buscar publicaci√≥n..." onkeyup="filterStock()">

            <table style="border-spacing: 0 15px;">
                <thead>
                    <tr>
                        <th style="width: 120px; text-align: center;">Imagen</th>
                        <th>Publicaci√≥n "Padre"</th>
                        <th>ID General</th>
                        <th style="text-align:center;">Inventario Total</th>
                        <th style="text-align:center;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="stockEditorTable">
                </tbody>
            </table>
        </div>

        <div id="bovedaClaves" style="display:none;">
            <h2>B√≥veda de Seguridad</h2>
            <p style="color: var(--text-gray); margin-bottom: 25px;">Guarda de forma privada los accesos de tus correos y plataformas de trabajo.</p>

            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;">
                <h4 style="margin-top:0; color: var(--corporate-blue); font-size: 12px; letter-spacing: 1px;">NUEVA CREDENCIAL</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div>
                        <label style="font-size: 11px; font-weight: 700; color: var(--text-gray); display: block; margin-bottom: 5px;">PLATAFORMA</label>
                        <input id="newSite" class="search-input" style="margin-top:0;" placeholder="Ej: Outlook Ventas">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: 700; color: var(--text-gray); display: block; margin-bottom: 5px;">USUARIO / EMAIL</label>
                        <input id="newUser" class="search-input" style="margin-top:0;" placeholder="usuario@correo.com">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: 700; color: var(--text-gray); display: block; margin-bottom: 5px;">CONTRASE√ëA</label>
                        <input id="newPass" class="search-input" style="margin-top:0;" placeholder="Clave...">
                    </div>
                    <button class="btn btn-sync" style="margin:0; height: 48px; padding: 0 25px;" onclick="saveNewCredential()">
                        <i class="fas fa-shield-alt"></i> Guardar
                    </button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="padding-left: 20px;">Plataforma</th>
                        <th>Usuario / Correo</th>
                        <th>Contrase√±a</th>
                        <th style="text-align:center;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="bovedaTable"></tbody>
            </table>
        </div>

    </div> </div>

<div id="live-toast" style="display: none; position: fixed; bottom: 30px; right: 30px; background-color: #28a745; color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; font-family: 'Inter', sans-serif; transition: opacity 0.5s; border-left: 6px solid #1e7e34; min-width: 280px;">
    <strong style="font-size: 16px; display: block; margin-bottom: 5px;">üîî Mercado Libre</strong>
    <span id="toast-message" style="font-size: 14px; font-weight: 500;">Mensaje de prueba</span>
</div>

<script>
const API = "https://marrokingcshop-api.onrender.com";

let allProducts = [];
let currentStatusFilter = "all";
let searchTimeout;

// ==========================================================
// NAVEGACI√ìN ENTRE SECCIONES (Actualizada üöÄ)
// ==========================================================
function showSection(sectionId) {
    // 1. Ocultamos TODAS las secciones para que no se encimen
    document.getElementById('inventario').style.display = 'none';
    document.getElementById('editarStock').style.display = 'none';
    document.getElementById('bovedaClaves').style.display = 'none';

    // 2. Mostramos la que elegiste
    document.getElementById(sectionId).style.display = 'block';

    // 3. Quitamos el color dorado de TODOS los botones del men√∫
    document.getElementById('link-inventario').classList.remove('active');
    document.getElementById('link-editarStock').classList.remove('active');
    document.getElementById('link-bovedaClaves').classList.remove('active');

    // 4. Se lo ponemos solo al bot√≥n que presionaste
    document.getElementById('link-' + sectionId).classList.add('active');

    // 5. ¬°VITAL! Si entras a la b√≥veda, pedimos los datos a la base de datos
    if (sectionId === 'bovedaClaves') {
        loadBoveda();
    }
}

window.onload = function(){
    const token = localStorage.getItem("token");
    if(token){
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardLayout").style.display = "flex";
        loadProducts();
        updateTimestamp(); 
        connectWebSocket(); // Radar encendido
    }
};

window.login = async function () {
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const resp = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
        })
    });

    const data = await resp.json();
    if (data.access_token) {
        localStorage.setItem("token", data.access_token);
        location.reload();
    } else {
        alert("Credenciales inv√°lidas");
    }
};

async function loadProducts() {
    if (!localStorage.getItem("token")) return;

    try {
        const token = localStorage.getItem("token");
        
        // üöÄ TRUCO: Agregamos ?t= y la hora actual en milisegundos
        // Esto obliga al navegador a pedir SIEMPRE datos frescos
        const urlRefrescada = API + "/products-grouped?t=" + Date.now();

        const resp = await fetch(urlRefrescada, {
            method: "GET",
            headers: { 
                "Authorization": "Bearer " + token,
                "Cache-Control": "no-cache", // üõ°Ô∏è Refuerzo extra anti-cach√©
                "Pragma": "no-cache"
            }
        });

        if (resp.status === 401 || resp.status === 403) {
            logout();
            return;
        }

        const data = await resp.json();
        allProducts = data.products || [];
        
        applyFilters(); 
        renderStockTable(allProducts); 
        
    } catch (error) {
        console.error("Error al conectar con el servidor:", error);
    }
}

function setStatusFilter(status, btnElement){
    currentStatusFilter = status;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');
    applyFilters();
}

function applyFilters(){
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchInput = document.getElementById("searchInput");
        const text = (searchInput.value || "").toLowerCase().trim();
        let filtered = [...allProducts];

        if(currentStatusFilter === "active"){
            filtered = filtered.filter(p => p.status === "active" && p.stock > 0);
        } 
        else if(currentStatusFilter === "paused"){
            filtered = filtered.filter(p => p.status !== "active");
        } 
        else if(currentStatusFilter === "nostock"){
            filtered = filtered.filter(p => p.stock === 0);
        }
        
        if(text){
            filtered = filtered.filter(p => (p.title || "").toLowerCase().includes(text));
        }

        renderTable(filtered);
    }, 300);
}

function renderTable(productsList){
    const table = document.getElementById("productTable");
    table.innerHTML = ""; 

    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:40px; color:var(--text-gray);'>No se encontraron productos</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    let htmlContent = "";
    productsList.forEach(item => {
        const status = (item.status || "").toLowerCase();
        let rowStyle = status !== "active" ? "opacity: 0.6; background:#f8f9fc;" : "";
        let stockColor = item.stock === 0 ? '#ff7675' : '#55efc4';
        let stockIcon = item.stock === 0 ? 'times-circle' : 'check-circle';

        htmlContent += `
            <tr style="${rowStyle}">
                <td style="padding-left: 30px;"><strong>${item.title}</strong></td>
                <td style="font-weight:600; color:var(--corporate-blue);">$${item.price || 0}</td>
                <td style="font-weight:bold; color:${stockColor};"><i class="fas fa-${stockIcon}"></i> ${item.stock}</td>
                <td style="font-family:monospace; font-size:12px; color:var(--text-gray);">${item.meli_item_id || ""}</td>
            </tr>
        `;
    });
    table.innerHTML = htmlContent;
}

function renderStockTable(productsList) {
    const table = document.getElementById("stockEditorTable");
    if(!table) return;
    
    if(productsList.length === 0) {
        table.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:40px; color:var(--text-gray);'>No hay publicaciones</td></tr>";
        return;
    }

    productsList.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    const grouped = {};
    productsList.forEach(p => {
        let parentId = p.meli_item_id;
        if (p.meli_item_id.includes("-")) {
            parentId = p.meli_item_id.split("-")[0];
        }

        if (!grouped[parentId]) {
            let mainTitle = p.title.split("(")[0].trim();
            grouped[parentId] = {
                parentId: parentId,
                title: mainTitle,
                thumbnail: p.thumbnail,
                totalStock: 0,
                variations: []
            };
        }
        grouped[parentId].variations.push(p);
        grouped[parentId].totalStock += (p.stock || 0);
    });

    let finalHTML = "";

    for (let parentId in grouped) {
        const group = grouped[parentId];
        let photo = group.thumbnail ? `<img src="${group.thumbnail}" class="product-thumb">` : "<div class='product-thumb' style='display:flex;align-items:center;justify-content:center;background:#eee;'><i class='fas fa-camera fa-2x'></i></div>";

        finalHTML += `
            <tr class="parent-row" onclick="toggleVariations('${parentId}', this)">
                <td style="text-align:center; padding: 15px;">${photo}</td>
                <td>
                    <div class="parent-title"><i class="fas fa-folder" style="color:var(--primary-gold);"></i> <span>${group.title}</span></div>
                </td>
                <td style="font-family:monospace; font-size:13px; color:var(--text-gray);">${parentId}</td>
                <td style="text-align:center;"><div class="total-stock">${group.totalStock} <small>unidades</small></div></td>
                <td style="text-align:center;">
                    <button class="view-variants-btn">Ver ${group.variations.length} variantes <i class="fas fa-chevron-down"></i></button>
                </td>
            </tr>
        `;

        let childRows = `<tr id="vars-${parentId}" style="display:none;"><td colspan="5" class="child-container"><table class="child-table">`;
        
        group.variations.forEach(v => {
            let varDetail = v.title.includes("(") ? v.title.substring(v.title.indexOf("(")) : "(Versi√≥n √önica)";
            childRows += `
                <tr>
                    <td style="width:60px; text-align:center; color:#ccc;"><i class="fas fa-level-up-alt fa-rotate-90"></i></td>
                    <td><div class="variant-title">${varDetail}</div></td>
                    <td></td>
                    <td>
                        <div class="stock-control">
                            <button class="btn-qty btn-minus" onclick="changeStock('${v.meli_item_id}', -1)"><i class="fas fa-minus"></i></button>
                            <span id="stock-val-${v.meli_item_id}" class="stock-val">${v.stock}</span>
                            <button class="btn-qty btn-plus" onclick="changeStock('${v.meli_item_id}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </td>
                    <td style="text-align:center;">
                        <button class="btn-save" onclick="saveStockToMeli('${v.meli_item_id}')">Guardar Stock</button>
                    </td>
                </tr>
            `;
        });
        childRows += `</table></td></tr>`;
        finalHTML += childRows;
    }
    table.innerHTML = finalHTML;
}

function toggleVariations(parentId, rowElement) {
    const row = document.getElementById(`vars-${parentId}`);
    const icon = rowElement.querySelector('.view-variants-btn i');
    if (row.style.display === "none") {
        row.style.display = "table-row";
        icon.className = 'fas fa-chevron-up';
    } else {
        row.style.display = "none";
        icon.className = 'fas fa-chevron-down';
    }
}

function changeStock(id, amount) {
    let span = document.getElementById(`stock-val-${id}`);
    let newStock = parseInt(span.innerText) + amount;
    if (newStock < 0) newStock = 0; 
    span.innerText = newStock;
}

async function saveStockToMeli(id) {
    let span = document.getElementById(`stock-val-${id}`);
    let newStock = parseInt(span.innerText);
    let token = localStorage.getItem("token");

    try {
        let response = await fetch(`${API}/meli/update_stock/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify({ new_stock: newStock })
        });
        if (response.ok) {
            alert("‚úÖ Actualizado");
            loadProducts();
            updateTimestamp();
        }
    } catch (error) { console.error(error); }
}

function filterStock() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        let text = document.getElementById("searchStockInput").value.toLowerCase();
        let filtered = allProducts.filter(p => (p.title || "").toLowerCase().includes(text));
        renderStockTable(filtered);
    }, 300);
}

async function syncML(){
    const btn = document.querySelector(".btn-sync");
    btn.disabled = true;
    try {
        const token = localStorage.getItem("token");
        const resp = await fetch(API + "/meli/sync", {
            method:"POST",
            headers:{ "Authorization": "Bearer " + token }
        });
        if(resp.ok){
            await loadProducts();
            updateTimestamp();
            alert("‚úÖ Sincronizado");
        }
    } catch (e) { console.error(e); }
    finally { btn.disabled = false; }
}

function logout(){
    localStorage.removeItem("token");
    location.reload();
}

function updateTimestamp() {
    const ahora = new Date();
    const horaTexto = ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const elemento = document.getElementById("last-update-time");
    if (elemento) elemento.innerHTML = "‚è±Ô∏è Sincronizado autom√°ticamente: " + horaTexto;
}

// Reloj de respaldo largo (10 min) para probar el t√∫nel en vivo
setInterval(() => {
    if (localStorage.getItem("token")) {
        loadProducts(); 
        updateTimestamp();
    }
}, 600000); 

// ==========================================================
// T√öNEL EN VIVO (WEBSOCKETS) üöá
// ==========================================================
function connectWebSocket() {
    const wsUrl = API.replace("http://", "ws://").replace("https://", "wss://") + "/ws/notifications";
    const socket = new WebSocket(wsUrl);

    socket.onopen = function() { 
        console.log("‚úÖ Radar en vivo conectado"); 
    };

    // AQU√ç PEGAMOS EL BLOQUE NUEVO ‚¨áÔ∏è
    socket.onmessage = function(event) {
        console.log("üì° Datos recibidos:", event.data);
        try {
            const data = JSON.parse(event.data);
            if (data.type === "notification") {
                // 1. Alerta y sonido al instante ‚ö°
                showLiveToast(data.message || "Actualizaci√≥n detectada");
                
                // 2. Esperamos 12 segundos (Sincronizado con el servidor) üïí
                setTimeout(() => {
                    console.log("üîÑ Recargando datos frescos de la DB...");
                    loadProducts();
                    updateTimestamp();
                }, 12000); // <-- Cambiado de 7000 a 12000
            }
        } catch (e) { 
            console.error("Error en t√∫nel:", e); 
        }
    };

    socket.onclose = function() {
        console.log("‚ö†Ô∏è Desconectado. Reconectando...");
        setTimeout(connectWebSocket, 5000);
    };
}

function showLiveToast(message) {
    // üîî BLOQUE DE SONIDO: Genera un "beep" pro
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.type = 'sine'; // Tono suave
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // Nota La (aguda)
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime); // Volumen suave
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2); // Dura solo 0.2 segundos
    } catch (e) {
        console.log("No se pudo reproducir el sonido (esperando interacci√≥n del usuario)");
    }

    // üé® BLOQUE VISUAL (El que ya ten√≠as)
    const toast = document.getElementById("live-toast");
    const msgSpan = document.getElementById("toast-message");
    
    if (toast && msgSpan) {
        console.log("üé® Mostrando Toast con mensaje:", message);
        msgSpan.innerText = message;
        
        toast.style.display = "block";
        toast.style.opacity = "1";
        toast.style.zIndex = "10000"; 

        setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => { 
                toast.style.display = "none"; 
            }, 500);
        }, 6000);
    } else {
        console.error("‚ùå No encontr√© 'live-toast' en el HTML");
    }
}

// ==========================================================
// üîê FUNCIONES DE LA B√ìVEDA (EL CEREBRO)
// ==========================================================

async function loadBoveda() {
    const token = localStorage.getItem("token");
    try {
        const resp = await fetch(API + "/work-credentials", {
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await resp.json();
        const table = document.getElementById("bovedaTable");
        
        if(!table) return; // Seguridad por si no encuentra la tabla
        table.innerHTML = "";

        if (!data.credentials || data.credentials.length === 0) {
            table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:40px; color:var(--text-gray);'>La b√≥veda est√° vac√≠a.</td></tr>";
            return;
        }

        data.credentials.forEach(c => {
            table.innerHTML += `
                <tr>
                    <td style="padding-left: 20px;"><strong>${c.site_name}</strong></td>
                    <td><span style="color:var(--text-gray); font-size:13px;">${c.email_user}</span></td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="password" value="${c.password_val}" id="pass-${c.id}" readonly 
                                   style="border:none; background:none; font-family:monospace; width:110px; font-size:15px; color:var(--primary-gold); font-weight:bold;">
                            <button onclick="togglePass(${c.id})" style="border:none; background:none; cursor:pointer; color:#ccc;"><i class="fas fa-eye" id="eye-${c.id}"></i></button>
                            <button onclick="copyPass('${c.password_val}')" style="border:none; background:none; cursor:pointer; color:var(--corporate-blue);"><i class="fas fa-copy"></i></button>
                        </div>
                    </td>
                    <td style="text-align:center;">
                        <button class="btn" style="background:#fff0f0; color:#ff7675; padding:6px 10px; border-radius:8px;" onclick="deleteCredential(${c.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    } catch (e) { 
        console.error("Error en b√≥veda:", e); 
    }
}

async function saveNewCredential() {
    const site = document.getElementById("newSite").value;
    const user = document.getElementById("newUser").value;
    const pass = document.getElementById("newPass").value;
    const token = localStorage.getItem("token");

    if(!site || !user || !pass) {
        alert("‚ö†Ô∏è Por favor llena todos los campos");
        return;
    }

    try {
        const resp = await fetch(API + "/work-credentials", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({ site_name: site, email_user: user, password_val: pass, category: "trabajo" })
        });

        if(resp.ok) {
            document.getElementById("newSite").value = "";
            document.getElementById("newUser").value = "";
            document.getElementById("newPass").value = "";
            loadBoveda();
            showLiveToast("‚úÖ Guardado en la b√≥veda con √©xito");
        } else {
            alert("Error al guardar. Revisa la consola.");
        }
    } catch (error) {
        console.error("Error al guardar credencial:", error);
    }
}

async function deleteCredential(id) {
    if(!confirm("¬øBorrar esta clave permanentemente?")) return;
    const token = localStorage.getItem("token");
    try {
        await fetch(API + `/work-credentials/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });
        loadBoveda();
    } catch (e) { console.error(e); }
}

function togglePass(id) {
    const input = document.getElementById(`pass-${id}`);
    const eye = document.getElementById(`eye-${id}`);
    if(input.type === "password") {
        input.type = "text";
        eye.className = "fas fa-eye-slash";
    } else {
        input.type = "password";
        eye.className = "fas fa-eye";
    }
}

function copyPass(val) {
    navigator.clipboard.writeText(val);
    showLiveToast("üìã Contrase√±a copiada al portapapeles");
}
</script>

</body>
</html>